var useless_ornament = [];
var endless_summer = false;
var SUN_IDX=0;

$(function (){
     $('.popbox').popbox();

    var counter = 0;
    var increase = Math.PI * 2 / 150;
     var it = setInterval(function (){
          y = Math.sin( counter ) / 2 + 5;
          counter += increase;
          y = parseInt(y * 20);

         $('#message-box').css({'margin-top':y });
     },20);
     useless_ornament.push(it);
});

function build_invite(){
    $.get('http://localhost:8075/sunset/invite/',{'user':window.user}, function ( data ){
        var link = 'http://duskjacket.com/peer-to-peer-sunset/?sunset='+data;
        $("#link-value").val(link);

        $("#link-value").fadeIn();
        $("#link-value").focus();
        $("#link-value").select();
    });
}

jQuery.fn.exists=function(){return this.length>0};function randrange(d,c){low=Math.min(d,c);high=Math.max(d,c);return Math.floor(low+((high-(low-1))*Math.random()))}function map(f,g,e,i,h){return(f-g)/(e-g)*(h-i)+i}function dateDecimal(a){return a.getHours()+a.getMinutes()/60+a.getSeconds()/(60*60)}function randrangef(d,c){low=Math.min(d,c);high=Math.max(d,c);r=low+((high-(low-1))*Math.random());return r>high?high:r}function ColorArray(d,c,a){if(typeof(d)!="undefined"&&typeof(c)!="undefined"&&typeof(a)!="undefined"){return new Array(d,c,a,1)}else{return new Array(randrange(0,255),randrange(0,255),randrange(0,255),1)}}var x_factor=0.2;var y_factor=3;function sin(a){s=parseInt(Math.sin(a*x_factor)*y_factor);return s}var x_factor2=0.5;var y_factor2=20;function sin2(a){s=parseInt(Math.sin(a*x_factor2)*y_factor2);return s}function Color(f,e,c,d){f=(f==undefined?255:f);e=(e==undefined?255:e);c=(c==undefined?255:c);d=(d==undefined?255:d);return"rgba("+f+","+e+","+c+","+d+")"}function elapsedDay(b,a){return((12-a)+(a-12))}function elapsedNight(b,a){return((24-a)+(12-b))}function format(a){return"rgb("+a[0]+","+a[1]+","+a[2]+")"}function formatGS(b){var a=parseInt((0.299*b[0]+0.587*b[1]+0.114*b[2]));return"rgb("+a+","+a+","+a+")"}function epoch(){return new Date().getTime()/1000}var sunset_states=[];var fallback=[[[104,139,242],[242,235,104]],[[115,136,240],[237,228,99]],[[91,104,240],[230,220,87]],[[101,91,240],[232,220,84]],[[114,91,240],[230,217,74]],[[138,91,240],[232,218,65]],[[156,91,240],[240,220,43]],[[173,91,240],[240,201,43]],[[185,91,240],[240,168,43]],[[203,91,240],[247,169,35]],[[228,91,240],[245,134,37]],[[240,91,240],[245,122,39]],[[240,91,218],[245,105,39]],[[240,91,205],[245,87,39]],[[240,91,181],[245,81,39]],[[240,91,151],[245,63,39]],[[240,56,132],[245,39,39]],[[240,57,146],[235,50,50]],[[240,57,167],[227,63,63]],[[240,57,191],[224,72,72]],[[240,57,219],[224,90,90]],[[232,69,216],[230,106,106]],[[245,90,232],[242,126,126]],[[212,87,202],[230,129,129]],[[173,90,167],[194,120,120]],[[153,89,149],[179,86,86]],[[122,85,120],[163,54,54]],[[94,70,93],[148,35,35]],[[64,49,63],[112,38,38]],[[61,54,61],[87,36,36]],[[48,36,48],[59,29,29]],[[48,36,48],[48,30,30]]];$(function(){$.getJSON("/sunset/load-colors/",{id:SUN_IDX},function(a){sunset_states=a.data;timelength=a.length}).error(function(){sunset_states=fallback;timelength=fallback.length})});

var max=Math.max;var abs=Math.abs;var floor=Math.floor;function Sky(){this.init=function(){this.c=0;this.c2=0;this.day=true;this.sun=[253,255,61];this.sky=[214,255,252];this.step_by=1;this.state_ptr=[];this.c_epoch=epoch();this.c2_epoch=epoch();this.epochStep=5;this.grayscale=false;this.it=0;this.it2=0;this.thresh=0;this.thresh2=0};this.setPos=function(a){this.pos=a};this.setEpochs=function(){this.c_epoch=epoch();this.c2_epoch=epoch()};this.resetCursors=function(){this.c=0;this.c2=0};this.calculate_steps=function(e){var b=e*(60*60);this.epochStep=b/this.state_ptr.length;var d,c,a;d=this.sky;c=this.state_ptr[this.c][0];a=max(abs(c[0]-d[0]),abs(c[1]-d[1]),abs(c[2]-d[2]));this.thresh=floor(this.epochStep/a);d=this.sun;c=this.state_ptr[this.c2][1];a=max(abs(c[0]-d[0]),abs(c[1]-d[1]),abs(c[2]-d[2]));this.thresh2=floor(this.epochStep/a);this.it=epoch();this.it2=epoch()};this.step=function(){if((epoch()-this.it)>=this.thresh){this.it=epoch();if(this.sky[0]<this.state_ptr[this.c][0][0]){this.sky[0]+=this.step_by}else{if(this.sky[0]>this.state_ptr[this.c][0][0]){this.sky[0]-=this.step_by}}if(this.sky[1]<this.state_ptr[this.c][0][1]){this.sky[1]+=this.step_by}else{if(this.sky[1]>this.state_ptr[this.c][0][1]){this.sky[1]-=this.step_by}}if(this.sky[2]<this.state_ptr[this.c][0][2]){this.sky[2]+=this.step_by}else{if(this.sky[2]>this.state_ptr[this.c][0][2]){this.sky[2]-=this.step_by}}}if(((this.sky[0]>=this.state_ptr[this.c][0][0]-(this.step_by))&&(this.sky[0]<=this.state_ptr[this.c][0][0]+(this.step_by)))&&((this.sky[1]>=this.state_ptr[this.c][0][1]-(this.step_by))&&(this.sky[1]<=this.state_ptr[this.c][0][1]+(this.step_by)))&&((this.sky[2]>=this.state_ptr[this.c][0][2]-(this.step_by))&&(this.sky[2]<=this.state_ptr[this.c][0][2]+(this.step_by)))){if((epoch()-this.c_epoch)>=this.epochStep&&this.c<this.state_ptr.length-1){this.c++;this.c_epoch=epoch();var c,b,a;c=this.sky;b=this.state_ptr[this.c][0];a=max(abs(b[0]-c[0]),abs(b[1]-c[1]),abs(b[2]-c[2]));this.thresh=floor(this.epochStep/a);if(master){window.sunset.socket.emit("tick",{peer:window.sunset.peer,step:this.c,epoch:this.c_epoch})}}}if((epoch()-this.it2)>=this.thresh2){this.it2=epoch();if(this.sun[0]<this.state_ptr[this.c2][1][0]){this.sun[0]+=this.step_by}else{if(this.sun[0]>this.state_ptr[this.c2][1][0]){this.sun[0]-=this.step_by}}if(this.sun[1]<this.state_ptr[this.c2][1][1]){this.sun[1]+=this.step_by}else{if(this.sun[1]>this.state_ptr[this.c2][1][1]){this.sun[1]-=this.step_by}}if(this.sun[2]<this.state_ptr[this.c2][1][2]){this.sun[2]+=this.step_by}else{if(this.sun[2]>this.state_ptr[this.c2][1][2]){this.sun[2]-=this.step_by}}}if(((this.sun[0]>=this.state_ptr[this.c2][1][0]-(this.step_by))&&(this.sun[0]<=this.state_ptr[this.c2][1][0]+(this.step_by)))&&((this.sun[1]>=this.state_ptr[this.c2][1][1]-(this.step_by))&&(this.sun[1]<=this.state_ptr[this.c2][1][1]+(this.step_by)))&&((this.sun[2]>=this.state_ptr[this.c2][1][2]-(this.step_by))&&(this.sun[2]<=this.state_ptr[this.c2][1][2]+(this.step_by)))){if((epoch()-this.c2_epoch)>=this.epochStep&&this.c2<this.state_ptr.length-1){this.c2++;this.c2_epoch=epoch();var c,b,a;c=this.sun;b=this.state_ptr[this.c2][1];a=max(abs(b[0]-c[0]),abs(b[1]-c[1]),abs(b[2]-c[2]));this.thresh2=floor(this.epochStep/a)}}};this.draw=function(){if(this.grayscale){$("#sky").css({background:"-webkit-radial-gradient(50% "+parseInt(this.pos)+"px, circle farthest-corner, "+formatGS(this.sun)+" 0%, "+formatGS(this.sky)+" 80%)"})}else{$("#sky").css({background:"-webkit-radial-gradient(50% "+parseInt(this.pos)+"px, circle farthest-corner, "+format(this.sun)+" 0%, "+format(this.sky)+" 80%)"})}}};

function Sun(){this.init=function(){this.r=110;this.origin={x:window.innerWidth/2-11,y:-11};$("#sun").css({top:this.pos});this.s=15;this.dec=0;this.steps=50;this.height=240;this.pos=window.innerHeight+this.height;this.sunrise_sunset=false};this.setPos=function(a){this.pos=a};this.draw=function(){$("#sun").css({top:this.pos})}};

var data="";var sunset="";var sun,sky,begin,end,begin_d,end_d;var sunsetd=0;var advance=0;var first=true;var timelength=10;var DEBUG=false;function gotoGrayScale(){$(".messages").each(function(){$(this).remove()});for(var b=0;b<useless_ornament.length;b++){clearInterval(useless_ornament[b])}sky.grayscale=true;$("#sky").append('<div class="warning" id="message-box"><a href="/SUNSET/" class="end">(lost connection to peer)</a></div>');var a=0;var d=Math.PI*2/150;var c=setInterval(function(){y=Math.sin(a)/2+5;a+=d;y=parseInt(y*20);$("#message-box").css({"margin-top":y})},20);sky.draw();if(endless_summer){setTimeout(function(){window.location.reload()},5000)}}$(function(){sun=new Sun();sun.init();sky=new Sky();sky.init();sky.setPos(window.innerHeight-sun.height*2);sky.draw();$(document).keypress(function(b){var a=(b.keyCode?b.keyCode:b.which);if(a==100){if($("#debug").is(":visible")){$("#debug").css({display:"none"});DEBUG=false}else{$("#debug").css({display:"inline"});DEBUG=true}}})});function make_sunset(){$(".messages").each(function(){$(this).remove()});for(var b=0;b<useless_ornament.length;b++){clearInterval(useless_ornament[b])}begin=new Date(new Date());end=new Date(new Date().setMinutes(begin.getMinutes()+timelength));begin_d=dateDecimal(begin);end_d=dateDecimal(end);sky.state_ptr=sunset_states;sky.calculate_steps(end_d-begin_d);var a=setInterval(function(){now=new Date(new Date());var c=dateDecimal(now);if(DEBUG){$("#debug").html("begin: "+begin+"<BR>                             end: "+end+"<BR>                time remaining: "+(now>end?"0:00":parseInt((dateDecimal(end)-dateDecimal(now))*60)+":"+(60-(now.getSeconds())))+"<BR>       pos: "+sky.pos+"<BR>                            c_epoch: "+parseInt(epoch()-sky.c_epoch)+" c2_epoch: "+parseInt(epoch()-sky.c2_epoch)+" thrsh: "+parseInt(sky.epochStep)+"<BR>                            c:"+sky.c+" c2: "+sky.c2)}if(now>end){clearInterval(a);if(endless_summer){setTimeout(function(){window.location.reload()},5000)}}var d=map(c,begin_d,end_d,window.innerHeight-sun.height*2,window.innerHeight+sun.height*2);sky.setPos(d);sky.step();sky.draw()},300)};

var master=false;function querystring(){var b=new RegExp("(?:\\?|&)(.*?)=(.*?)(?=&|$)","gi");var c={},a;while((a=b.exec(document.location.search))!=null){c[a[1]]=a[2]}return c}(function(){SunsetManager=Backbone.View.extend({DEBUG:true,unitary:false,initialize:function(){_.bindAll(this,"update");if(this.DEBUG){console.log("connecting")}this.socket=io.connect("http://localhost:8075");this.socket.on("connect",_.bind(function(){console.log("connected");qs=querystring();if(qs.sunset){this.socket.emit("subscribe",{sunset:qs.sunset})}else{this.socket.emit("enter",{user:window.user})}if(document.location.search=="?endless"){endless_summer=true;$("#message-box2").remove()}},this));this.socket.on("error",function(a){console.log("System",a?a:"A unknown error occurred")});this.socket.on("disconnect",_.bind(function(a){if(this.DEBUG){console.log("disconnected")}gotoGrayScale()},this));this.socket.on("message",_.bind(function(a){if(this.DEBUG){console.log(a.message)}},this));this.socket.on("update",_.bind(function(a){if(this.DEBUG){console.log("update:"+a)}o=a;this.update(a)},this));this.socket.on("wait",function(a){console.log("waiting")});if(!this.unitary){window.onbeforeunload=_.bind(function(a){this.socket.emit("exit",{user:window.user})},this)}},update:function(a){switch(a.action){case"start":make_sunset();this.peer=a.peer;master=a.master;SUN_IDX=a.sun_idx;break;case"tick":if(sky.c!=a.step){sky.c=a.step;sky.c2=a.step;sky.c_epoch=a.epoch;sky.c2_epoch=a.epoch}break;case"exit":gotoGrayScale();break}}});$(function(){window.sunset=new SunsetManager()})})();